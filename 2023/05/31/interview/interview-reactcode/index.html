<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>前端进阶（React v17.0.2源码） | Neil&#39;s Blog</title>
    <meta name="author" content="Neil Ji" />
    <meta name="keywords" content="" />
    <meta name="description" content="资源一览React v17.0.2源码在线编辑器（vscode）React v17.0.2源码仓库（github）React内部函数调用关系草图Mount阶段大致如下，可供参考，缩进意为被上一层调用，标记!!!的注释意为核心代码。123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Neil&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 6.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Neil&#39;s Blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <!-- <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://neil-ji.github.io"></form> -->

        
            
                
                    

                        
                            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%B8%80%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">资源一览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#React%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB%E8%8D%89%E5%9B%BE"><span class="toc-number">2.</span> <span class="toc-text">React内部函数调用关系草图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mount%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">Mount基本流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%BB%84%E4%BB%B6Update%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">类组件Update基本流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%B7%E7%82%B9%E2%80%94%E2%80%94classComponentUpdater"><span class="toc-number">4.1.</span> <span class="toc-text">起点——classComponentUpdater</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86%E6%9B%B4%E6%96%B0%E2%80%94%E2%80%94UpdateQueue"><span class="toc-number">4.2.</span> <span class="toc-text">批处理更新——UpdateQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setState%E6%98%AF%E5%BC%82%E6%AD%A5%E8%BF%98%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84%EF%BC%9F"><span class="toc-number">4.2.1.</span> <span class="toc-text">setState是异步还是同步的？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%B0%83%E5%BA%A6%E2%80%94%E2%80%94scheduleUpdateOnFiber"><span class="toc-number">4.3.</span> <span class="toc-text">开始调度——scheduleUpdateOnFiber</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Loop"><span class="toc-number">5.</span> <span class="toc-text">Work Loop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#workLoopSync"><span class="toc-number">5.1.</span> <span class="toc-text">workLoopSync</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#performUnitOfWork"><span class="toc-number">5.1.1.</span> <span class="toc-text">performUnitOfWork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#beginWork"><span class="toc-number">5.1.2.</span> <span class="toc-text">beginWork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateClassComponent"><span class="toc-number">5.1.3.</span> <span class="toc-text">updateClassComponent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#constructClassInstance"><span class="toc-number">5.1.4.</span> <span class="toc-text">constructClassInstance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mountClassInstance"><span class="toc-number">5.1.5.</span> <span class="toc-text">mountClassInstance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateClassInstance"><span class="toc-number">5.1.6.</span> <span class="toc-text">updateClassInstance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#finishClassComponent"><span class="toc-number">5.1.7.</span> <span class="toc-text">finishClassComponent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workLoopConcurrent"><span class="toc-number">5.2.</span> <span class="toc-text">workLoopConcurrent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%87%E6%B3%A8"><span class="toc-number">6.</span> <span class="toc-text">备注</span></a></li></ol>
                                
    </div>
</aside>
</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            前端进阶（React v17.0.2源码）
        </h1>
        
        <div class="article-meta clearfix">
            
            <a class="article-date" href="/archives/2023/05/31">
    
    <i class="icon-calendar vm"></i>
    
    
        <span class="vm">Created at</span>
    
    <time class="vm" datetime="2023-05-31T07:11:19.000Z" itemprop="datePublished">2023-05-31</time>
</a>

            <div class="article-updated">
    
    <i class="icon-calendar vm"></i>
    
    
        <span class="vm">Modified at</span>
    
    <time class="vm" datetime="2023-07-06T09:49:55.383Z" itemprop="datePublished">2023-07-06</time>
</div>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6/" rel="tag">前端进阶</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        <div>
            
            
                
            
            
                <h2 id="资源一览"><a href="#资源一览" class="headerlink" title="资源一览"></a>资源一览</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github1s.com/neil-ji/react/blob/HEAD/packages/">React v17.0.2源码在线编辑器（vscode）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/neil-ji/react/blob/HEAD/packages/">React v17.0.2源码仓库（github）</a></li>
</ul>
<h2 id="React内部函数调用关系草图"><a href="#React内部函数调用关系草图" class="headerlink" title="React内部函数调用关系草图"></a>React内部函数调用关系草图</h2><p>Mount阶段大致如下，可供参考，缩进意为被上一层调用，标记<code>!!!</code>的注释意为核心代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="property">render</span></span><br><span class="line">    legacyRenderSubtreeIntoContainer</span><br><span class="line">        legacyCreateRootFromDOMContainer</span><br><span class="line">            createRoot</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ReactDOMRoot</span></span><br><span class="line">                    createRootImpl</span><br><span class="line">                        createContainer </span><br><span class="line">                            createFiberRoot </span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">FiberRootNode</span></span><br><span class="line">                                    createHostRootFiber</span><br><span class="line">                                        createFiber </span><br><span class="line">                                            <span class="keyword">new</span> <span class="title class_">FiberNode</span></span><br><span class="line">                                            initializeUpdateQueue</span><br><span class="line">        unbatchedUpdates</span><br><span class="line">            updateContainer</span><br><span class="line">                requestEventTime</span><br><span class="line">                requestUpdateLane</span><br><span class="line">                getContextForSubtree</span><br><span class="line">                createUpdate</span><br><span class="line">                enqueueUpdate</span><br><span class="line">                scheduleUpdateOnFiber <span class="comment">// !!! reconcile开始</span></span><br><span class="line">                    markUpdateLaneFromFiberToRoot <span class="comment">// 从当前节点到根节点，依次更新节点的Lane</span></span><br><span class="line">                    markRootUpdated <span class="comment">// 根节点标记为：存在pending update</span></span><br><span class="line">                    performSyncWorkOnRoot <span class="comment">// !!! reconcile开始</span></span><br><span class="line">                        getNextLanes</span><br><span class="line">                        renderRootSync</span><br><span class="line">                            prepareFreshStack <span class="comment">// 初始化Work Loop必需的所有变量</span></span><br><span class="line">                                createWorkInProgress</span><br><span class="line">                                    createFiber</span><br><span class="line">                                enqueueInterleavedUpdates</span><br><span class="line">                            pushDispatcher <span class="comment">// 设置一个ReactCurrentDispatcher，主要用于处理Hooks</span></span><br><span class="line">                            workLoopSync <span class="comment">// !!! 循环处理unitOfWork，正在处理的work称为workInProgress</span></span><br><span class="line">                                performUnitOfWork</span><br><span class="line">                                    beginWork <span class="comment">// !!! 沿child构建Fiber，直到child为null</span></span><br><span class="line">                                        updateHostRoot <span class="comment">// !!! 不同的任务有不同的函数去处理</span></span><br><span class="line">                                            pushHostRootContext</span><br><span class="line">                                            cloneUpdateQueue</span><br><span class="line">                                            processUpdateQueue <span class="comment">// 处理update queue，计算出最终state</span></span><br><span class="line">                                            reconcileChildren <span class="comment">// 处理children</span></span><br><span class="line">                                                mountChildFibers</span><br><span class="line">                                                    reconcileChildFibers</span><br><span class="line">                                                        placeSingleChild</span><br><span class="line">                                                            reconcileSingleElement</span><br><span class="line">                                    completeUnitOfWork <span class="comment">// !!! 将sibling设为workInProgress，没有则沿return找父节点的sibling，直到return为null</span></span><br><span class="line">                                        completeWork</span><br><span class="line">                            resetContextDependencies</span><br><span class="line">                            popDispatcher <span class="comment">// render结束，还原Dispatcher</span></span><br><span class="line">                        commitRoot</span><br><span class="line">                            commitRootImpl</span><br><span class="line">                                commitBeforeMutationEffects <span class="comment">// !!! 1阶段，Before Mutation，执行生命周期函数</span></span><br><span class="line">                                    prepareForCommit</span><br><span class="line">                                    commitBeforeMutationEffects_begin</span><br><span class="line">                                        commitBeforeMutationEffects_complete</span><br><span class="line">                                            commitBeforeMutationEffectsOnFiber <span class="comment">// 执行getSnapshotBeforeUpdate</span></span><br><span class="line">                                commitMutationEffects <span class="comment">// !!! 2阶段，根据fiber.flags更新DOM</span></span><br><span class="line">                                    commitMutationEffects_begin</span><br><span class="line">                                        commitMutationEffects_complete</span><br><span class="line">                                            commitDetachRef <span class="comment">// 解除ref</span></span><br><span class="line">                                            commitAttachRef <span class="comment">// 重新设置ref</span></span><br><span class="line">                                            commitPlacement</span><br><span class="line">                                                insertOrAppendPlacementNodeIntoContainer <span class="comment">// React DOM Api</span></span><br><span class="line">                                                insertOrAppendPlacementNode <span class="comment">// React DOM Api</span></span><br><span class="line">                                            commitWork</span><br><span class="line">                                                commitHookEffectListUnmount</span><br><span class="line">                                                commitContainer</span><br><span class="line">                                                    replaceContainerChildren <span class="comment">// React DOM Api</span></span><br><span class="line">                                commitLayoutEffects <span class="comment">// !!! 3阶段，执行layout</span></span><br><span class="line">                                    commitLayoutEffects_begin <span class="comment">// componentDidMount</span></span><br><span class="line">                                        safelyCallCommitHookLayoutEffectListMount</span><br><span class="line">                                            commitHookEffectListMount <span class="comment">// HookLayout</span></span><br><span class="line">                    ensureRootIsScheduled</span><br><span class="line">                entangleTransitions</span><br><span class="line">        getPublicRootInstance</span><br></pre></td></tr></table></figure>

<p>Update阶段（setState，其他类似）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setState</span></span><br><span class="line">    classComponentUpdater.<span class="property">enqueueSetState</span></span><br><span class="line">        createUpdate</span><br><span class="line">        enqueueUpdate</span><br><span class="line">        scheduleUpdateOnFiber <span class="comment">// !!!核心函数</span></span><br><span class="line">            ensureRootIsScheduled</span><br><span class="line">                performConcurrentWorkOnRoot</span><br><span class="line">                    renderRootConcurrent</span><br><span class="line">                        pushDispatcher</span><br><span class="line">                        workLoopConcurrent <span class="comment">// !!!循环处理unitOfWork，正在处理的work称为workInProgress</span></span><br><span class="line">                            shouldYield <span class="comment">// !!!来自scheduler，为true时停止任务处理</span></span><br><span class="line">                            performUnitOfWork <span class="comment">// 和Mount类似，只不过只处理更新阶段对应的任务，以下省略</span></span><br><span class="line">                        popDispatcher</span><br><span class="line">                    finishConcurrentRender</span><br><span class="line">                        commitRoot <span class="comment">// 省略</span></span><br></pre></td></tr></table></figure>

<h2 id="Mount基本流程"><a href="#Mount基本流程" class="headerlink" title="Mount基本流程"></a>Mount基本流程</h2><ol>
<li>React.createElement()构建出React DOM；</li>
<li>ReactDOM.render()是React App初始化的起点，以下API如无特殊说明，默认属于<code>reconciler</code>库；<ol>
<li>构建两个互相引用的实例：fiberRoot是整个App的根节点，rootFiber是基于ReactDOM构建的Fiber Tree的根节点；</li>
<li>updateContainer正式开始reconcile过程，在此期间触发的更新以unbatched形式执行，主要执行两个函数：<ol>
<li>renderRootSync，进入render阶段，核心函数调用为：<ol>
<li>pushDispatcher，初始化一个ReactCurrentDispatcher，内含所有React Hook的实现；</li>
<li>workLoopSync，不同类型的FiberNode在render阶段对应不同的任务（例如类组件和函数组件，任务显然不同），WorkLoopSync通过一个循环<strong>同步地</strong>处理这些任务；</li>
<li>popDispatcher，还原ReactCurrentDispatcher；</li>
</ol>
</li>
<li>commitRoot，进入commit阶段，根据Diff结果更新浏览器DOM，触发对应Effect Hook或生命周期方法；</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="类组件Update基本流程"><a href="#类组件Update基本流程" class="headerlink" title="类组件Update基本流程"></a>类组件Update基本流程</h2><p>类组件有两种更新组件的方式：</p>
<ol>
<li>setState；</li>
<li>forceUpdate；</li>
</ol>
<p>这两个都是定义在React.Component.prototype上的方法，流程相似。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setState</span> = <span class="keyword">function</span>(<span class="params">partialState, callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueSetState</span>(<span class="variable language_">this</span>, partialState, callback, <span class="string">&#x27;setState&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forceUpdate</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueForceUpdate</span>(<span class="variable language_">this</span>, callback, <span class="string">&#x27;forceUpdate&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以setState为例的流程：</p>
<ol>
<li>创建update对象并添加进updateQueue；</li>
<li>调用scheduleUpdateOnFiber，开始处理更新：<ol>
<li>如果是batchedUpdates，则每次取消上个调度任务，再重新申请一个新的调度任务；</li>
<li>否则直接申请一个调度任务；</li>
</ol>
</li>
<li>轮到该任务执行时，进入workLoop</li>
</ol>
<p>注：被调度的任务就是<code>performConcurrentWorkOnRoot</code>函数；</p>
<h3 id="起点——classComponentUpdater"><a href="#起点——classComponentUpdater" class="headerlink" title="起点——classComponentUpdater"></a>起点——<code>classComponentUpdater</code></h3><p>实际调用的是<code>this.updater.enqueueSetState</code>，<code>this.updater</code>是在render阶段的<code>updateClassComponent</code> -&gt; <code>constructClassInstance</code> -&gt; <code>adoptClassInstance</code>函数中注入的。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">adoptClassInstance</span>(<span class="params">workInProgress: Fiber, instance: <span class="built_in">any</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 注意这一行!!!instance就是ClassComponent的实例</span></span><br><span class="line">  instance.<span class="property">updater</span> = classComponentUpdater;</span><br><span class="line">  workInProgress.<span class="property">stateNode</span> = instance;</span><br><span class="line">  <span class="comment">// The instance needs access to the fiber so that it can schedule updates</span></span><br><span class="line">  <span class="title function_">setInstance</span>(instance, workInProgress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对照关系：</p>
<ol>
<li>setState：实际调用classComponentUpdater.enqueueSetState；</li>
<li>forceUpdate：实际调用classComponentUpdater.enqueueForceUpdate；</li>
</ol>
<p>其实这两个方法逻辑几乎一样，唯一不同点是setState需要携带上payload，也就是组件中调用setState时传入的partialState，而forceUpdate不需要携带payload，只是把update.tag置为ForceUpdate（一个二进制数）。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  <span class="title function_">enqueueSetState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst);</span><br><span class="line">    <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>();</span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane);</span><br><span class="line">    update.<span class="property">payload</span> = payload;</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.<span class="property">callback</span> = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">enqueueUpdate</span>(fiber, update, lane);</span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">entangleTransitions</span>(root, fiber, lane);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">enqueueForceUpdate</span>(<span class="params">inst, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst);</span><br><span class="line">    <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>();</span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane);</span><br><span class="line">    update.<span class="property">tag</span> = <span class="title class_">ForceUpdate</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.<span class="property">callback</span> = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">enqueueUpdate</span>(fiber, update, lane);</span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">entangleTransitions</span>(root, fiber, lane);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="批处理更新——UpdateQueue"><a href="#批处理更新——UpdateQueue" class="headerlink" title="批处理更新——UpdateQueue"></a>批处理更新——<code>UpdateQueue</code></h3><p>setState&#x2F;forceUpdate&#x2F;react hook等触发的更新会创建一个update对象，并添加到updateQueue，这是为了实现更新批处理而设计的，批处理生效期间，多次更新按顺序加到updateQueue中，期间每个更新会取消上一次更新的任务调度，并申请一次新的任务调度（scheduler提供任务调度能力），直到批处理结束，进入下一轮事件循环，被调度的任务得到执行机会，真正进入render阶段并通过<code>processUpdateQueue</code>一次性处理所有更新。</p>
<p>React合成事件默认开启更新批处理，其他场景必须手动调用<code>unstable_batchedUpdates</code>，例如异步的回调（setTimeout、Promise.then等）是无法批处理的，这里引申一个常见问题——setState是异步还是同步的？</p>
<p>注：这篇博客讲的非常好——<a target="_blank" rel="noopener" href="https://juejin.cn/post/6978304166154207239#heading-2">React 源码解读之 Automatic Batching</a></p>
<h4 id="setState是异步还是同步的？"><a href="#setState是异步还是同步的？" class="headerlink" title="setState是异步还是同步的？"></a><code>setState</code>是异步还是同步的？</h4><p>合成事件与生命周期函数中是异步的，异步函数回调与原生事件中是同步的。</p>
<p>注意，此处同步、异步并非指setState在JS引擎层面的同步或异步，而是指this.state的更新能否立刻体现出来：</p>
<ol>
<li>同步：setState后立刻可以通过this.state取到更新后的state；</li>
<li>异步：setState后不能立刻取到更新后的state；</li>
</ol>
<p>从源码层面解释：</p>
<ol>
<li>合成事件默认开启更新批处理，setState执行后并不会在本次事件循环中完成state更新，因此批处理结束前不能获取到最新state；</li>
<li>生命周期方法中的setState执行后，state的赋值不是立刻执行的，因此也无法得到最新state；</li>
</ol>
<p>异步函数、原生事件的回调中不会应用更新批处理，因此每个setState都会触发一次render、commit，因此可以setState后立刻获得最新state；</p>
<h3 id="开始调度——scheduleUpdateOnFiber"><a href="#开始调度——scheduleUpdateOnFiber" class="headerlink" title="开始调度——scheduleUpdateOnFiber"></a>开始调度——<code>scheduleUpdateOnFiber</code></h3><p>update会被赋予一个优先级，根据优先级选择对应的任务调度方式，SyncLane直接调用<code>performSyncWorkOnRoot</code>处理。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scheduleUpdateOnFiber</span></span><br><span class="line"><span class="keyword">if</span> (lane === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// Check if we&#x27;re inside unbatchedUpdates</span></span><br><span class="line">        (executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// Check if we&#x27;re not already rendering</span></span><br><span class="line">        (executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) === <span class="title class_">NoContext</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span></span><br><span class="line">        <span class="comment">// root inside of batchedUpdates should be synchronous, but layout updates</span></span><br><span class="line">        <span class="comment">// should be deferred until the end of the batch.</span></span><br><span class="line">        <span class="title function_">performSyncWorkOnRoot</span>(root);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, eventTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其他优先级通过<code>ensureRootIsScheduled</code>-&gt;<code>scheduleCallback</code>调度一个<code>performConcurrentWorkOnRoot</code>函数。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ensureRootIsScheduled</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// !!!batchedUpdates情况下，取消上一次调度</span></span><br><span class="line"><span class="keyword">if</span> (existingCallbackNode != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Cancel the existing callback. We&#x27;ll schedule a new one below.</span></span><br><span class="line">    <span class="title function_">cancelCallback</span>(existingCallbackNode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// !!!申请一个新的调度任务</span></span><br><span class="line"><span class="keyword">let</span> newCallbackNode;</span><br><span class="line"><span class="keyword">if</span> (newCallbackPriority === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> schedulerPriorityLevel;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="title function_">lanesToEventPriority</span>(nextLanes)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">DiscreteEventPriority</span>:</span><br><span class="line">        schedulerPriorityLevel = <span class="title class_">ImmediateSchedulerPriority</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ContinuousEventPriority</span>:</span><br><span class="line">        schedulerPriorityLevel = <span class="title class_">UserBlockingSchedulerPriority</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">DefaultEventPriority</span>:</span><br><span class="line">        schedulerPriorityLevel = <span class="title class_">NormalSchedulerPriority</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">IdleEventPriority</span>:</span><br><span class="line">        schedulerPriorityLevel = <span class="title class_">IdleSchedulerPriority</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">        schedulerPriorityLevel = <span class="title class_">NormalSchedulerPriority</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// !!!看这里，调度一个performConcurrentWorkOnRoot</span></span><br><span class="line">    newCallbackNode = <span class="title function_">scheduleCallback</span>(</span><br><span class="line">        schedulerPriorityLevel,</span><br><span class="line">        performConcurrentWorkOnRoot.<span class="title function_">bind</span>(<span class="literal">null</span>, root),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performConcurrentWorkOnRoot</code>得到执行机会时，会去执行<code>renderRootConcurrent</code>，若已经超时则直接以同步优先级执行<code>renderRootSync</code>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// performConcurrentWorkOnRoot</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> exitStatus =</span><br><span class="line">    <span class="title function_">shouldTimeSlice</span>(root, lanes) &amp;&amp;</span><br><span class="line">    (disableSchedulerTimeoutInWorkLoop || !didTimeout)</span><br><span class="line">      ? <span class="title function_">renderRootConcurrent</span>(root, lanes)</span><br><span class="line">      : <span class="title function_">renderRootSync</span>(root, lanes);</span><br></pre></td></tr></table></figure>

<h2 id="Work-Loop"><a href="#Work-Loop" class="headerlink" title="Work Loop"></a>Work Loop</h2><p>Work Loop根据Legacy&#x2F;Concurrent模式的不同，分为两套逻辑，但总的来说，不同Fiber节点的不同阶段各有不同的任务，二者都是为了循环处理每个Fiber节点对应的任务：</p>
<ol>
<li><code>workLoopSync</code></li>
<li><code>workLoopConcurrent</code></li>
</ol>
<p>核心逻辑中的相关变量定义：</p>
<ul>
<li><code>workInProgress</code>：当前正在处理的Fiber；</li>
<li><code>unitOfWork</code>：每个Fiber节点都有对应的一系列任务，译为工作单元；</li>
</ul>
<p>Fiber节点重要属性：</p>
<ul>
<li><code>child</code>：指向首个子节点；</li>
<li><code>sibling</code>：指向右侧首个兄弟节点（此处右指的是ReactDOM画图后方向上的右，注意树是没有逻辑上的左右之分的，只有二叉树有）；</li>
<li><code>return</code>：指向父节点；</li>
</ul>
<h3 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>workLoopSync很简单，就是循环处理workInProgress，处理完一个，再将下一个Fiber节点赋值给workInProgress，处理顺序可看作树的DFS，或者将FiberTree看作孩子-兄弟表示法得到的二叉树（左孩子，右兄弟），则顺序就是二叉树的先序遍历：</p>
<p>伪代码表示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 如果child存在，则切换到child；</span></span><br><span class="line"><span class="comment">// 2 否则：</span></span><br><span class="line"><span class="comment">//   2.1 如果sibling存在，切换到sibling，跳到1；</span></span><br><span class="line"><span class="comment">//   2.2 否则，通过return切换到父节点，跳到2.1；</span></span><br></pre></td></tr></table></figure>

<h4 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h4><p>performUnitOfWork就是unitOfWork的处理函数，它的作用就是处理当前任务，并得到下个待处理的Fiber节点；</p>
<p>注意FiberTree是有两颗的，互相以alternate指向各自对应节点，这两颗树一个是workInProgress，代表当前正在处理的页面；一个是current，代表当前正在显示的页面；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">  <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">  <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.<span class="property">alternate</span>;</span><br><span class="line">  <span class="title function_">setCurrentDebugFiberInDEV</span>(unitOfWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (unitOfWork.<span class="property">mode</span> &amp; <span class="title class_">ProfileMode</span>) !== <span class="title class_">NoMode</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next = <span class="title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//resetCurrentDebugFiberInDEV();</span></span><br><span class="line">  unitOfWork.<span class="property">memoizedProps</span> = unitOfWork.<span class="property">pendingProps</span>;</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn&#x27;t spawn new work, complete the current work.</span></span><br><span class="line">    <span class="title function_">completeUnitOfWork</span>(unitOfWork);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h4><p>beginWork代表任务开始处理，根据Mount、Update阶段的不同，以及组件类型的不同，各有其对应的处理函数，这里主要介绍ClassComponent和FunctionComponent.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  workInProgress.<span class="property">lanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Component</span> = workInProgress.<span class="property">type</span>;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.<span class="property">elementType</span> === <span class="title class_">Component</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : <span class="title function_">resolveDefaultProps</span>(<span class="title class_">Component</span>, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateFunctionComponent</span>(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Component</span> = workInProgress.<span class="property">type</span>;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.<span class="property">elementType</span> === <span class="title class_">Component</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : <span class="title function_">resolveDefaultProps</span>(<span class="title class_">Component</span>, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateClassComponent</span>(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateHostRoot</span>(current, workInProgress, renderLanes);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a><code>updateClassComponent</code></h4><p>updateClassComponent相对比较简单，核心逻辑就是：</p>
<ol>
<li>constructClassInstance，组件Mount时调用，</li>
<li>mountClassInstance，组件Mount时调用，</li>
<li>updateClassInstance，组件Update时调用，</li>
<li>finishClassComponent，beginWork结束时调用，获取下一个unitOfWork；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  Component: any,</span></span><br><span class="line"><span class="params">  nextProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> hasContext;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isLegacyContextProvider</span>(<span class="title class_">Component</span>)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">pushLegacyContextProvider</span>(workInProgress);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">prepareToReadContext</span>(workInProgress, renderLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      current.<span class="property">alternate</span> = <span class="literal">null</span>;</span><br><span class="line">      workInProgress.<span class="property">alternate</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.<span class="property">flags</span> |= <span class="title class_">Placement</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    <span class="title function_">constructClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps);</span><br><span class="line">    <span class="title function_">mountClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps, renderLanes);</span><br><span class="line">    shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we&#x27;ll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = <span class="title function_">resumeMountClassInstance</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    shouldUpdate = <span class="title function_">updateClassInstance</span>(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = <span class="title function_">finishClassComponent</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a>constructClassInstance</h4><h4 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a>mountClassInstance</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  ctor: any, <span class="comment">// constructor缩写</span></span></span><br><span class="line"><span class="params">  newProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">  instance.<span class="property">props</span> = newProps;</span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">  instance.<span class="property">refs</span> = emptyRefsObject;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.<span class="property">contextType</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">readContext</span>(contextType);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = emptyContextObject;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = <span class="title function_">getUnmaskedContext</span>(workInProgress, ctor, <span class="literal">true</span>);</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">getMaskedContext</span>(workInProgress, unmaskedContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用定义在组件构造函数上的static getDerivedStateFromProps()</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.<span class="property">getDerivedStateFromProps</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">applyDerivedStateFromProps</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps,</span><br><span class="line">    );</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In order to support react-lifecycles-compat polyfilled components,</span></span><br><span class="line">  <span class="comment">// Unsafe lifecycles should not be invoked for components using the new APIs.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.<span class="property">getSnapshotBeforeUpdate</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.<span class="property">UNSAFE_componentWillMount</span> === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.<span class="property">componentWillMount</span> === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">callComponentWillMount</span>(workInProgress, instance);</span><br><span class="line">    <span class="comment">// If we had additional state updates during this life-cycle, let&#x27;s</span></span><br><span class="line">    <span class="comment">// process them now.</span></span><br><span class="line">    <span class="title function_">processUpdateQueue</span>(workInProgress, newProps, instance, renderLanes);</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">fiberFlags</span>: <span class="title class_">Flags</span> = <span class="title class_">Update</span>;</span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= <span class="title class_">LayoutStatic</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      enableStrictEffects &amp;&amp;</span><br><span class="line">      (workInProgress.<span class="property">mode</span> &amp; <span class="title class_">StrictEffectsMode</span>) !== <span class="title class_">NoMode</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      fiberFlags |= <span class="title class_">MountLayoutDev</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.<span class="property">flags</span> |= fiberFlags;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="updateClassInstance"><a href="#updateClassInstance" class="headerlink" title="updateClassInstance"></a>updateClassInstance</h4><h4 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a>finishClassComponent</h4><h3 id="workLoopConcurrent"><a href="#workLoopConcurrent" class="headerlink" title="workLoopConcurrent"></a><code>workLoopConcurrent</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopConcurrent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Perform work until Scheduler asks us to yield</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYield</span>()) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然Concurrent模式下，与Legacy模式唯一的不同点就在于shouldYield函数的调用，shouldYield是scheduler导出的函数，简单来说，当时间分片已经耗尽时，就会通过shouldYield返回一个true，使Work Loop停止处理，等待下一时间分片；</p>
<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><ul>
<li>类组件state的更新发生在mountClassInstance，被赋值为workInProgress.memoizedState；</li>
</ul>

                </div>
            
    </section>
</article>




    <a id="pagenext" href="/2023/05/28/interview/interview-reactrouter/" class="article-next" title="前端进阶（react-router）"><i class="icon-arrow-right"></i></a>


    <a id="pageprev" href="/2023/05/31/react/react_fiber_node/" class="article-prev" title="React v17.0.2源码（Fiber Node）"><i class="icon-arrow-left"></i></a>





            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>

</body>
</html>
